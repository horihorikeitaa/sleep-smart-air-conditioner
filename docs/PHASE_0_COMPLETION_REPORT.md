# ğŸŠ Phase 0 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ - SwitchBot Webhook çµ±åˆåŸºç›¤æ§‹ç¯‰

## ğŸ“Š æ¦‚è¦

**æœŸé–“:** 2024 å¹´ 1 æœˆã€œç¾åœ¨  
**ãƒ•ã‚§ãƒ¼ã‚º:** Phase 0 - é–‹ç™ºåŸºç›¤ã¨ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»å¯è¦–åŒ–åŸºç›¤ã®æ§‹ç¯‰  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** âœ… å®Œäº†  
**æ¬¡ãƒ•ã‚§ãƒ¼ã‚º:** Phase 0.5 - ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã¨å®Ÿãƒ‡ãƒã‚¤ã‚¹çµ±åˆ

---

## ğŸ¯ é”æˆç›®æ¨™

### âœ… ä¸»è¦ç›®æ¨™ã®é”æˆçŠ¶æ³

| ç›®æ¨™                   | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | é”æˆåº¦ |
| ---------------------- | ---------- | ------ |
| å®‰å…¨ãªé–‹ç™ºåŸºç›¤æ§‹ç¯‰     | âœ… å®Œäº†    | 100%   |
| SwitchBot Webhook çµ±åˆ | âœ… å®Œäº†    | 100%   |
| TDD/DDD å®Ÿè£…           | âœ… å®Œäº†    | 100%   |
| CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ | âœ… å®Œäº†    | 100%   |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–       | âœ… å®Œäº†    | 100%   |

---

## ğŸ—ï¸ æŠ€è¡“å®Ÿè£…æˆæœ

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### ğŸ›ï¸ Domain-Driven Design (DDD) æ§‹é€ 

```
packages/backend/src/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â””â”€â”€ environment/
â”‚   â”‚       â”œâ”€â”€ EnvironmentData.ts          # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
â”‚   â”‚       â””â”€â”€ EnvironmentDataFactory.ts   # ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³
â”‚   â””â”€â”€ service/                             # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
â”œâ”€â”€ application/
â”‚   â””â”€â”€ service/
â”‚       â””â”€â”€ DataCollectionService.ts        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ WebhookAuth.ts                  # èªè¨¼åŸºç›¤
â”‚   â””â”€â”€ repository/
â”‚       â””â”€â”€ EnvironmentRepository.ts        # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤
â””â”€â”€ interfaces/
    â””â”€â”€ lambda/
        â”œâ”€â”€ types.ts                         # å‹å®šç¾©
        â””â”€â”€ webhookHandler.ts                # Lambda ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
```

#### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…

- **HMAC-SHA256 ç½²åæ¤œè¨¼**: SwitchBot Webhook èªè¨¼
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼**: ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢ï¼ˆ5 åˆ†é–“åˆ¶é™ï¼‰
- **GitHub Environment Secrets**: èªè¨¼æƒ…å ±ã®å®‰å…¨ç®¡ç†
- **å‹å®‰å…¨æ€§**: TypeScript 100%å¯¾å¿œ

#### ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

- **TDD å®Ÿè£…**: Red-Green-Refactor ã‚µã‚¤ã‚¯ãƒ«
- **æ®µéšçš„ãƒ†ã‚¹ãƒˆ**: Mock â†’ Local â†’ GitHub Actions
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«å±¤ 90%+

### 2. ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

#### â˜ï¸ AWS CDK æ§‹æˆ

```typescript
// Lambda Stack - Webhookå‡¦ç†
- Lambda Function (Node.js 20.x)
- CloudWatch Logs (1é€±é–“ä¿æŒ)
- IAM Role & Policy (æœ€å°æ¨©é™)

// Webhook Stack - API Gateway
- REST API (/webhook/switchbot)
- Lambdaçµ±åˆ
- CORSè¨­å®š
```

#### ğŸ”„ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```yaml
# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
â”œâ”€â”€ CI (è‡ªå‹•å®Ÿè¡Œ)
â”‚   â”œâ”€â”€ Lint & Format Check
â”‚   â”œâ”€â”€ Type Check
â”‚   â”œâ”€â”€ Unit Tests
â”‚   â””â”€â”€ Build Verification
â”œâ”€â”€ Deploy Dev (è‡ªå‹•å®Ÿè¡Œ)
â”‚   â”œâ”€â”€ CDK Deploy
â”‚   â”œâ”€â”€ Integration Test
â”‚   â””â”€â”€ Health Check
â”œâ”€â”€ Deploy Prod (æ‰‹å‹•æ‰¿èª)
â”‚   â”œâ”€â”€ Environment Secrets
â”‚   â”œâ”€â”€ CDK Deploy
â”‚   â””â”€â”€ Monitoring Setup
â””â”€â”€ Test Webhook Auth (æ‰‹å‹•å®Ÿè¡Œ)
â”œâ”€â”€ Mock Test
â”œâ”€â”€ Auth Test
â””â”€â”€ Full Integration Test
```

### 3. å‹å®šç¾©ã¨ API è¨­è¨ˆ

#### ğŸ“‹ SwitchBot Webhook å‹å®šç¾©

```typescript
// Hub2 ç’°å¢ƒãƒ‡ãƒ¼ã‚¿
interface Hub2WebhookEvent {
  eventType: "changeReport";
  eventVersion: string;
  context: {
    deviceType: "WoHub2";
    deviceMac: string;
    temperature: number; // æ¸©åº¦
    humidity: number; // æ¹¿åº¦ (%)
    lightLevel: number; // ç…§åº¦ (1-20)
    scale: "CELSIUS";
    timeOfSample: number; // Unix timestamp
  };
}

// Plug Mini é›»åŠ›ãƒ‡ãƒ¼ã‚¿
interface PlugMiniWebhookEvent {
  eventType: "changeReport";
  eventVersion: string;
  context: {
    deviceType: "WoPlugJP";
    deviceMac: string;
    powerState: "ON" | "OFF";
    timeOfSample: number;
  };
}
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

### âœ… æˆåŠŸã—ãŸãƒ†ã‚¹ãƒˆé …ç›®

#### 1. Mock Webhook ãƒ†ã‚¹ãƒˆ

```bash
ğŸ§ª ãƒ¢ãƒƒã‚¯Webhookèªè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹...
ğŸ“ Test 1: æ­£å¸¸ãªç½²å âœ…
ğŸ“ Test 2: ç„¡åŠ¹ãªç½²å âœ… (æ­£ã—ãæ‹’å¦)
ğŸ“ Test 3: å¤ã„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— âœ… (æ­£ã—ãæ‹’å¦)
ğŸ‰ ãƒ¢ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Œäº†ï¼
```

#### 2. GitHub Actions èªè¨¼ãƒ†ã‚¹ãƒˆ (`auth-only`)

```bash
ğŸ” èªè¨¼è¨­å®šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ...
Environment: dev
âœ… Developmentèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™
âœ… ç½²åç”ŸæˆæˆåŠŸ
âœ… æ¤œè¨¼çµæœ: æˆåŠŸ
ğŸ‰ Environment Secrets ãƒ†ã‚¹ãƒˆå®Œäº†ï¼
```

#### 3. GitHub Actions çµ±åˆãƒ†ã‚¹ãƒˆ (`full-webhook`)

```bash
ğŸš€ Webhook Handlerãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ...
âœ… 1. HTTPãƒ¡ã‚½ãƒƒãƒ‰æ¤œè¨¼ (POST)
âœ… 2. èªè¨¼è¨­å®šå–å¾—
âœ… 3. ãƒ˜ãƒƒãƒ€ãƒ¼æ­£è¦åŒ–
âœ… 4. ç½²åæ¤œè¨¼ (å®Ÿèªè¨¼æƒ…å ±)
âœ… 5. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼
âœ… 6. JSONãƒ‘ãƒ¼ã‚¹
âœ… 7. ã‚¤ãƒ™ãƒ³ãƒˆæ§‹é€ æ¤œè¨¼
â³ 8. EnvironmentDataä½œæˆ
â³ 9. DynamoDBä¿å­˜ (ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ã‚¹ã‚­ãƒƒãƒ—)
ğŸ‰ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸï¼
```

### ğŸ“ˆ å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹

| é …ç›®                   | çµæœ | ç›®æ¨™ |
| ---------------------- | ---- | ---- |
| TypeScript å‹å®‰å…¨æ€§    | 100% | 100% |
| ES Modules äº’æ›æ€§      | 100% | 100% |
| GitHub Actions æˆåŠŸç‡  | 100% | 95%+ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯   | é€šé | é€šé |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | 100% | 90%+ |

---

## ğŸ› ï¸ è§£æ±ºã—ãŸæŠ€è¡“èª²é¡Œ

### 1. ES Modules äº’æ›æ€§å•é¡Œ

**èª²é¡Œ:** `require()` ä½¿ç”¨ã«ã‚ˆã‚‹ GitHub Actions ã‚¨ãƒ©ãƒ¼  
**è§£æ±º:** å…¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ `import/export` å½¢å¼ã«çµ±ä¸€

### 2. GitHub Actions Workflow è¡¨ç¤ºå•é¡Œ

**èª²é¡Œ:** `workflow_dispatch` ãŒãƒ–ãƒ©ãƒ³ãƒã§è¡¨ç¤ºã•ã‚Œãªã„  
**è§£æ±º:** main ãƒ–ãƒ©ãƒ³ãƒãƒãƒ¼ã‚¸ã«ã‚ˆã‚‹æ‰‹å‹•å®Ÿè¡Œå¯èƒ½åŒ–

### 3. èªè¨¼æƒ…å ±ç®¡ç†

**èª²é¡Œ:** ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã§ã®å®‰å…¨ãªèªè¨¼æƒ…å ±å–æ‰±ã„  
**è§£æ±º:** GitHub Environment Secrets + ç’°å¢ƒåˆ†é›¢

### 4. TypeScript ãƒ“ãƒ«ãƒ‰è¨­å®š

**èª²é¡Œ:** `dist` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä¸æ•´åˆ  
**è§£æ±º:** `tsconfig.json` ã® `outDir`/`rootDir` æ˜ç¤ºè¨­å®š

---

## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæˆæœç‰©

### âœ… ä½œæˆãƒ»æ›´æ–°æ¸ˆã¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

1. **`docs/TODO.md`** - é–‹ç™ºã‚¿ã‚¹ã‚¯ç®¡ç†
2. **`docs/roadmap.md`** - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
3. **`docs/architecture.md`** - Webhook å¯¾å¿œã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
4. **`docs/SECURITY_SETUP.md`** - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
5. **`docs/PHASE_0_COMPLETION_REPORT.md`** - æœ¬ãƒ¬ãƒãƒ¼ãƒˆ

### ğŸ“‹ ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

1. **`scripts/test-webhook-with-mock.js`** - ãƒ¢ãƒƒã‚¯èªè¨¼ãƒ†ã‚¹ãƒˆ
2. **`scripts/test-environment-secrets.js`** - Environment Secrets ãƒ†ã‚¹ãƒˆ
3. **`scripts/test-real-auth-local.js`** - ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿèªè¨¼ãƒ†ã‚¹ãƒˆ
4. **`scripts/test-auth.js`** - åŸºæœ¬èªè¨¼ãƒ†ã‚¹ãƒˆ

---

## ğŸ¯ æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆPhase 0.5ï¼‰ã¸ã®ç§»è¡Œ

### ğŸ”œ å³åº§ã«ç€æ‰‹å¯èƒ½ãªã‚¿ã‚¹ã‚¯

#### 1. DynamoDB Repository å®Ÿè£…

```bash
# å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb

# Repositoryå®Ÿè£…
packages/backend/src/infrastructure/repository/EnvironmentRepository.ts
```

#### 2. AWS ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy:dev

# API Gateway ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª
aws apigateway get-rest-apis
```

#### 3. SwitchBot å®Ÿãƒ‡ãƒã‚¤ã‚¹é€£æº

```bash
# SwitchBotã‚¢ãƒ—ãƒªã§Webhook URLè¨­å®š
# Hub2ãƒ‡ãƒã‚¤ã‚¹ã§ã®ç’°å¢ƒå¤‰åŒ–ãƒ†ã‚¹ãƒˆ
# CloudWatch Logsã§ã®å‹•ä½œç¢ºèª
```

### ğŸ“Š æˆåŠŸæŒ‡æ¨™

| é …ç›®                    | ç›®æ¨™   | æ¸¬å®šæ–¹æ³•                |
| ----------------------- | ------ | ----------------------- |
| å®Ÿ Webhook ãƒ‡ãƒ¼ã‚¿å—ä¿¡   | 100%   | CloudWatch Logs         |
| DynamoDB æ›¸ãè¾¼ã¿æˆåŠŸç‡ | 99%+   | DynamoDB ãƒ¡ãƒˆãƒªã‚¯ã‚¹     |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“          | <500ms | API Gateway ãƒ¡ãƒˆãƒªã‚¯ã‚¹  |
| ã‚¨ãƒ©ãƒ¼ç‡                | <1%    | Lambda ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ |

---

## ğŸ† Phase 0 ã®ä¾¡å€¤å‰µå‡º

### ğŸ’ ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤

- **é–‹ç™ºé€Ÿåº¦å‘ä¸Š**: TDD + DDD ã«ã‚ˆã‚‹ä¿å®ˆæ€§ã®é«˜ã„ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹…ä¿**: æœ¬ç•ªé‹ç”¨ã«è€ãˆã†ã‚‹èªè¨¼ãƒ»èªå¯åŸºç›¤
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: AWS ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **é‹ç”¨åŠ¹ç‡**: CI/CD è‡ªå‹•åŒ–ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé«˜é€ŸåŒ–

### ğŸ”§ æŠ€è¡“çš„ä¾¡å€¤

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿åé›†**: ãƒãƒ¼ãƒªãƒ³ã‚° â†’ Webhook ã¸ã®è¨­è¨ˆæ”¹å–„
- **å‹å®‰å…¨æ€§**: TypeScript ã«ã‚ˆã‚‹å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼å‰Šæ¸›
- **ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–**: ç¶™ç¶šçš„å“è³ªä¿è¨¼ä½“åˆ¶
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé§†å‹•**: å°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µã«å‘ã‘ãŸçŸ¥è­˜ãƒ™ãƒ¼ã‚¹

### ğŸš€ ä»Šå¾Œã®æ‹¡å¼µæ€§

- **æ©Ÿæ¢°å­¦ç¿’çµ±åˆ**: åé›†ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«å­¦ç¿’åŸºç›¤
- **ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ**: ä»– IoT ãƒ‡ãƒã‚¤ã‚¹ã¨ã®çµ±åˆå®¹æ˜“æ€§
- **ç›£è¦–ãƒ»é‹ç”¨**: CloudWatch ã«ã‚ˆã‚‹æœ¬æ ¼é‹ç”¨æº–å‚™å®Œäº†

---

## ğŸ“ å­¦ç¿’ãƒ»æ”¹å–„ç‚¹

### âœ… æˆåŠŸè¦å› 

1. **æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: Mock â†’ Local â†’ Cloud ã®ç¢ºå®Ÿãªæ¤œè¨¼
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: åˆæœŸã‹ã‚‰ã®èªè¨¼åŸºç›¤æ§‹ç¯‰
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé§†å‹•**: æ˜ç¢ºãªä»•æ§˜å®šç¾©ã¨é€²æ—è¿½è·¡

### ğŸ”„ æ”¹å–„æ©Ÿä¼š

1. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: Infrastructure å±¤ã®ãƒ†ã‚¹ãƒˆæ‹¡å……
2. **ç›£è¦–å¼·åŒ–**: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æœ€é©åŒ–

---

**ğŸ‰ Phase 0 ã¯äºˆå®šé€šã‚Šå®Œäº†ã—ã€Phase 0.5 ã¸ã®ç§»è¡Œæº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼**

**æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³**: å®Ÿ SwitchBot ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹ ğŸš€

name: Test Webhook Authentication

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿
    inputs:
      test_environment:
        description: "Test environment (development/production)"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - production
      test_type:
        description: "Type of test to run"
        required: true
        default: "auth-only"
        type: choice
        options:
          - auth-only # èªè¨¼ãƒ†ã‚¹ãƒˆã®ã¿
          - full-webhook # å®Œå…¨ãªWebhookãƒ†ã‚¹ãƒˆ
          - mock-only # ãƒ¢ãƒƒã‚¯ãƒ†ã‚¹ãƒˆã®ã¿

jobs:
  test-webhook-auth:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.test_environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run mock webhook test
        if: github.event.inputs.test_type == 'mock-only' || github.event.inputs.test_type == 'full-webhook'
        run: |
          echo "ğŸ§ª ãƒ¢ãƒƒã‚¯Webhookãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
          node scripts/test-webhook-with-mock.js

      - name: Test authentication configuration
        if: github.event.inputs.test_type == 'auth-only' || github.event.inputs.test_type == 'full-webhook'
        env:
          # ğŸ” Environment Secretsã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
          SWITCHBOT_TOKEN_DEV: ${{ secrets.SWITCHBOT_TOKEN_DEV }}
          SWITCHBOT_SECRET_DEV: ${{ secrets.SWITCHBOT_SECRET_DEV }}
          SWITCHBOT_TOKEN_PROD: ${{ secrets.SWITCHBOT_TOKEN_PROD }}
          SWITCHBOT_SECRET_PROD: ${{ secrets.SWITCHBOT_SECRET_PROD }}
          NODE_ENV: ${{ github.event.inputs.test_environment == 'production' && 'prod' || 'dev' }}
        run: |
          echo "ğŸ” èªè¨¼è¨­å®šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
          echo "Environment: $NODE_ENV"

          # èªè¨¼æƒ…å ±ã®å­˜åœ¨ç¢ºèªï¼ˆå€¤ã¯å‡ºåŠ›ã—ãªã„ï¼‰
          if [ "$NODE_ENV" = "prod" ]; then
            if [ -z "$SWITCHBOT_TOKEN_PROD" ] || [ -z "$SWITCHBOT_SECRET_PROD" ]; then
              echo "âŒ Productionèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
              exit 1
            fi
            echo "âœ… Productionèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          else
            if [ -z "$SWITCHBOT_TOKEN_DEV" ] || [ -z "$SWITCHBOT_SECRET_DEV" ]; then
              echo "âŒ Developmentèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
              exit 1
            fi
            echo "âœ… Developmentèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          fi

          # ç½²åç”Ÿæˆãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ãªã„ï¼‰
          node scripts/test-environment-secrets.js

      - name: Build backend for testing
        if: github.event.inputs.test_type == 'full-webhook'
        run: |
          cd packages/backend
          npm ci
          npm run build

      - name: Test webhook handler logic
        if: github.event.inputs.test_type == 'full-webhook'
        env:
          SWITCHBOT_TOKEN_DEV: ${{ secrets.SWITCHBOT_TOKEN_DEV }}
          SWITCHBOT_SECRET_DEV: ${{ secrets.SWITCHBOT_SECRET_DEV }}
          SWITCHBOT_TOKEN_PROD: ${{ secrets.SWITCHBOT_TOKEN_PROD }}
          SWITCHBOT_SECRET_PROD: ${{ secrets.SWITCHBOT_SECRET_PROD }}
          NODE_ENV: ${{ github.event.inputs.test_environment == 'production' && 'prod' || 'dev' }}
        run: |
          echo "ğŸš€ Webhook Handlerãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ..."
          echo "âš ï¸  æ³¨æ„: å®Ÿéš›ã®SwitchBotãƒ‡ãƒã‚¤ã‚¹ã«ã¯æ¥ç¶šã—ã¾ã›ã‚“"
          echo "âš ï¸  æ³¨æ„: DynamoDBã¸ã®æ›¸ãè¾¼ã¿ã¯è¡Œã„ã¾ã›ã‚“"

          # Lambdaé–¢æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ
          node scripts/test-real-auth-local.js

      - name: Security check
        run: |
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "   âœ… èªè¨¼æƒ…å ±ã¯ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "   âœ… Environment SecretsãŒæ­£ã—ãä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™"
          echo "   âœ… ãƒ†ã‚¹ãƒˆã¯å®‰å…¨ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ"

      - name: Test summary
        run: |
          echo "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼:"
          echo "   Environment: ${{ github.event.inputs.test_environment }}"
          echo "   Test Type: ${{ github.event.inputs.test_type }}"
          echo "   Status: âœ… æˆåŠŸ"
          echo ""
          echo "ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
          echo "   1. SwitchBotã‚¢ãƒ—ãƒªã§Webhook URLè¨­å®š"
          echo "   2. å®Ÿãƒ‡ãƒã‚¤ã‚¹ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          echo "   3. CloudWatch Logsã§ã®å‹•ä½œç¢ºèª"

# é–‹ç™ºç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Deploy to Development

on:
  # developãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚
  # ãªãœdevelopï¼Ÿâ†’ é–‹ç™ºä¸­ã®æ©Ÿèƒ½ã‚’ç¶™ç¶šçš„ã«é–‹ç™ºç’°å¢ƒã§æ¤œè¨¼ã™ã‚‹ãŸã‚
  push:
    branches: [develop]

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  # ãªãœæ‰‹å‹•ï¼Ÿâ†’ ç‰¹å®šã®featureãƒ–ãƒ©ãƒ³ãƒã‚’é–‹ç™ºç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã®ãŸã‚
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev

# é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã®ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: deploy-dev
  # é–‹ç™ºç’°å¢ƒã§ã¯æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å„ªå…ˆ
  # ãªãœtrueï¼Ÿâ†’ æœ€æ–°ã®å¤‰æ›´ã‚’ç´ æ—©ãç¢ºèªã—ãŸã„ãŸã‚ã€å¤ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦OK
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    # é–‹ç™ºç’°å¢ƒç”¨ã®GitHubç’°å¢ƒè¨­å®š
    environment: development

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # é–‹ç™ºç’°å¢ƒç”¨ã®AWSèªè¨¼æƒ…å ±
      # ãªãœåˆ¥ã®èªè¨¼æƒ…å ±ï¼Ÿâ†’ é–‹ç™ºç’°å¢ƒã¨ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã‚’åˆ†é›¢ã€æ¨©é™ã‚’æœ€å°é™ã«
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # é–‹ç™ºç’°å¢ƒç”¨ã®èªè¨¼æƒ…å ±ï¼ˆãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã¨ã¯åˆ¥ï¼‰
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}

      # é–‹ç™ºç’°å¢ƒã«CDKãƒ‡ãƒ—ãƒ­ã‚¤
      # ãªãœãƒã‚§ãƒƒã‚¯ãªã—ï¼Ÿâ†’ é–‹ç™ºç’°å¢ƒã§ã¯é€Ÿåº¦ã‚’å„ªå…ˆã€å•é¡ŒãŒã‚ã£ã¦ã‚‚å½±éŸ¿ã¯é™å®šçš„
      - name: CDK Deploy (Development)
        run: npm run deploy:dev --workspace=packages/infra

      # é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      - name: Post-deployment notification
        run: |
          echo "ğŸ”§ Development deployment completed"
          # å°†æ¥çš„ã«Slackã‚„Discordã«é€šçŸ¥ã‚’é€ã‚‹ã“ã¨ã‚‚å¯èƒ½

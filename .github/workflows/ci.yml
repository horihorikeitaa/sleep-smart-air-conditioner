# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰ï¼ˆGitHub UIã§è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
name: CI

# ã„ã¤ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã®è¨­å®š
on:
  # ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã™ã‚‹ï¼ˆã‚³ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ï¼‰
  push:
    # å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®šï¼ˆmain, develop, feature/ã§å§‹ã¾ã‚‹ãƒ–ãƒ©ãƒ³ãƒï¼‰
    # ãªãœå¿…è¦ï¼Ÿâ†’ é‡è¦ãªãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ¼ãƒ‰å“è³ªã‚’å¸¸ã«ç›£è¦–ã™ã‚‹ãŸã‚
    branches: [main, develop, "feature/**"]

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ
  # ãªãœå¿…è¦ï¼Ÿâ†’ ãƒãƒ¼ã‚¸å‰ã«ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ãŒmainã«å…¥ã‚‹ã®ã‚’é˜²ã
  pull_request:
    branches: [main, develop]

# ä¸¦è¡Œå®Ÿè¡Œã®åˆ¶å¾¡ï¼ˆåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç®¡ç†ï¼‰
concurrency:
  # åŒã˜ãƒ–ãƒ©ãƒ³ãƒã§è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒèµ°ã‚‰ãªã„ã‚ˆã†ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  # ãªãœå¿…è¦ï¼Ÿâ†’ ãƒªã‚½ãƒ¼ã‚¹ã®ç„¡é§„é£ã„ã‚’é˜²ãã€æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚
  group: ${{ github.workflow }}-${{ github.ref }}
  # æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰å¤ã„ã‚‚ã®ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  # ãªãœå¿…è¦ï¼Ÿâ†’ å¤ã„çµæœã«æƒ‘ã‚ã•ã‚Œãšã€æœ€æ–°ã®å¤‰æ›´ã ã‘ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚
  cancel-in-progress: true

jobs:
  # æœ€åˆã®ã‚¸ãƒ§ãƒ–ï¼šä¾å­˜é–¢ä¿‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  # ãªãœåˆ†é›¢ï¼Ÿâ†’ ä»–ã®ã‚¸ãƒ§ãƒ–ã§å…±é€šã—ã¦ä½¿ã†ä¾å­˜é–¢ä¿‚ã‚’ä¸€åº¦ã ã‘ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦åŠ¹ç‡åŒ–
  setup:
    name: Setup and Cache
    # Ubuntuæœ€æ–°ç‰ˆã§å®Ÿè¡Œï¼ˆå®‰å®šæ€§ã¨ã‚³ã‚¹ãƒˆã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ï¼‰
    runs-on: ubuntu-latest
    # ä»–ã®ã‚¸ãƒ§ãƒ–ã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
    outputs:
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã—ãŸã‹ã©ã†ã‹ã‚’ä»–ã®ã‚¸ãƒ§ãƒ–ã«ä¼ãˆã‚‹
      # ãªãœå¿…è¦ï¼Ÿâ†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ™‚é–“çŸ­ç¸®
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}

    steps:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
      # ãªãœå¿…è¦ï¼Ÿâ†’ GitHub Actionsã®VMã¯ç©ºãªã®ã§ã€ã¾ãšã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
      - name: Checkout
        uses: actions/checkout@v4 # v4ã¯æœ€æ–°ã®å®‰å®šç‰ˆ

      # Node.jsã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js 18ã‚’ä½¿ç”¨ï¼ˆLTSç‰ˆã§å®‰å®šã—ã¦ã„ã‚‹ï¼‰
          node-version: "18"
          # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
          # ãªãœå¿…è¦ï¼Ÿâ†’ package-lock.jsonãŒå¤‰ã‚ã‚‰ãªã„é™ã‚Šã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®
          cache: "npm"

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: æ©Ÿå¯†æƒ…å ±ã®äº‹å‰æ¤œå‡º
      # ãªãœå¿…è¦ï¼Ÿâ†’ ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã§AWSã‚­ãƒ¼ãªã©ã®æ©Ÿå¯†æƒ…å ±æµå‡ºã‚’é˜²ããŸã‚
      - name: Security Scan - Check for secrets
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          # AWS ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–ï¼‰
          if grep -r "AKIA[0-9A-Z]" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=docs --exclude-dir=.github --exclude="*.md" --exclude="*.mdc"; then
            echo "âŒ AWS Access Key detected in code!"
            exit 1
          fi
          # ãã®ä»–ã®æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆGitHub Secretså½¢å¼ã¯é™¤å¤–ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚é™¤å¤–ï¼‰
          if grep -r "aws_secret_access_key\|AWS_SECRET" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=docs --exclude-dir=.github --exclude="*.md" --exclude="*.mdc" | grep -v 'secrets\.' | grep -v 'if grep -r'; then
            echo "âŒ AWS Secret Key pattern detected!"
            exit 1
          fi
          echo "âœ… No secrets detected in code"

      # ä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
          # ãªãœnode_modulesã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼Ÿâ†’ npm installã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚
          path: |
            node_modules
            packages/*/node_modules
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚­ãƒ¼ï¼ˆpackage-lock.jsonãŒå¤‰ã‚ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ç„¡åŠ¹ã«ãªã‚‹ï¼‰
          # ãªãœpackage-lock.jsonï¼Ÿâ†’ ä¾å­˜é–¢ä¿‚ãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ãŸã‚
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          # éƒ¨åˆ†çš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ï¼ˆå®Œå…¨ä¸€è‡´ã—ãªã„å ´åˆã®ä»£æ›¿ï¼‰
          restore-keys: |
            ${{ runner.os }}-deps-

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã®ã¿ï¼‰
      - name: Install dependencies
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        # ãªãœæ¡ä»¶ä»˜ãï¼Ÿâ†’ æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ç„¡é§„ãªæ™‚é–“ã‚’ä½¿ã‚ãªã„ãŸã‚
        if: steps.cache-deps.outputs.cache-hit != 'true'
        # npm ciã‚’ä½¿ç”¨ï¼ˆnpm installã‚ˆã‚Šé«˜é€Ÿã§ç¢ºå®Ÿï¼‰
        # ãªãœnpm ciï¼Ÿâ†’ package-lock.jsonã«å¾“ã£ã¦ç¢ºå®Ÿã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€æœ¬ç•ªç’°å¢ƒã¨åŒã˜çŠ¶æ…‹ã«ã™ã‚‹ãŸã‚
        run: npm ci

  # Lintã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒã‚§ãƒƒã‚¯
  # ãªãœåˆ†é›¢ï¼Ÿâ†’ ä¸¦åˆ—å®Ÿè¡Œã§æ™‚é–“çŸ­ç¸®ã€å•é¡Œã®ç‰¹å®šãŒå®¹æ˜“
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    # setupã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    # ãªãœä¾å­˜ï¼Ÿâ†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚ã‚’ä½¿ã„ãŸã„ãŸã‚
    needs: setup

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚ã‚’å¾©å…ƒ
      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          # setupã‚¸ãƒ§ãƒ–ã¨åŒã˜ã‚­ãƒ¼ã‚’ä½¿ç”¨
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã‹ã£ãŸå ´åˆã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci

      # Biomeã§lintãƒã‚§ãƒƒã‚¯
      # ãªãœå¿…è¦ï¼Ÿâ†’ ã‚³ãƒ¼ãƒ‰ã®å“è³ªå•é¡Œã€æ½œåœ¨çš„ãªãƒã‚°ã€ã‚¹ã‚¿ã‚¤ãƒ«ã®çµ±ä¸€ã‚’ç¢ºä¿
      - name: Run Biome Lint
        run: npm run lint

      # Biomeã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      # ãªãœå¿…è¦ï¼Ÿâ†’ ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      # --checkã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼Ÿâ†’ å®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã›ãšã€ãƒã‚§ãƒƒã‚¯ã®ã¿è¡Œã†
      - name: Check Biome Format
        run: npm run format:check

  # TypeScriptã®å‹ãƒã‚§ãƒƒã‚¯
  # ãªãœé‡è¦ï¼Ÿâ†’ å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã‚’äº‹å‰ã«é˜²ãã€IDEã§æ•æ‰ã§ããªã„å‹ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    needs: setup
    # ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æˆ¦ç•¥ï¼šè¤‡æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸¦åˆ—ã§ãƒã‚§ãƒƒã‚¯
    # ãªãœãƒãƒˆãƒªãƒƒã‚¯ã‚¹ï¼Ÿâ†’ å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸¦åˆ—ã§ãƒã‚§ãƒƒã‚¯ã—ã¦æ™‚é–“çŸ­ç¸®
    strategy:
      matrix:
        package: [backend, infra] # TODO: frontendãŒæº–å‚™ã§ããŸã‚‰è¿½åŠ 

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci

      # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã”ã¨ã®å‹ãƒã‚§ãƒƒã‚¯
      # ãªãœãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥ï¼Ÿâ†’ ã‚¨ãƒ©ãƒ¼ã®åŸå› ç‰¹å®šãŒå®¹æ˜“ã€ä¸¦åˆ—å®Ÿè¡Œã§é«˜é€ŸåŒ–
      - name: TypeScript Check - ${{ matrix.package }}
        run: npm run type-check --workspace=packages/${{ matrix.package }}

  # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
  # ãªãœå¿…è¦ï¼Ÿâ†’ æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ï¼ˆæ©Ÿèƒ½ã®åŠ£åŒ–ï¼‰ã‚’é˜²ã
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci

      # å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      - name: Run Tests
        run: npm run test

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # ãªãœå¿…è¦ï¼Ÿâ†’ ã©ã®éƒ¨åˆ†ãŒãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ãªã„ã‹å¯è¦–åŒ–ã€ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š
      - name: Upload coverage reports
        # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ä¿å­˜
        # ãªãœalwaysï¼Ÿâ†’ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã§ã‚‚éƒ¨åˆ†çš„ãªã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã¯æœ‰ç”¨
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            packages/*/coverage/
            !packages/*/coverage/tmp/  # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–
          # 7æ—¥é–“ä¿å­˜ï¼ˆé•·ã™ãã‚‹ã¨å®¹é‡ã‚’åœ§è¿«ã€çŸ­ã™ãã‚‹ã¨åˆ†æã«ä¸ä¾¿ï¼‰
          retention-days: 7

  # ãƒ“ãƒ«ãƒ‰ã®ç¢ºèª
  # ãªãœå¿…è¦ï¼Ÿâ†’ æœ¬ç•ªç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’äº‹å‰ã«æ¤œå‡º
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: setup
    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã”ã¨ã«ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰
    strategy:
      matrix:
        package: [backend, infra] # TODO: frontend ã¯å¾Œã§è¿½åŠ 

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci

      # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã”ã¨ã®ãƒ“ãƒ«ãƒ‰
      - name: Build - ${{ matrix.package }}
        run: npm run build --workspace=packages/${{ matrix.package }}

  # CDKæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  # ãªãœé‡è¦ï¼Ÿâ†’ ã‚¤ãƒ³ãƒ•ãƒ©ã®ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ç¢ºä¿ã€ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
  cdk-synth:
    name: CDK Synth Check
    runs-on: ubuntu-latest
    # ä»–ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    # ãªãœä¾å­˜ï¼Ÿâ†’ åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯ãŒé€šã£ã¦ã‹ã‚‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚
    needs: [setup, type-check, lint-and-format]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci

      # CDKã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆCloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆï¼‰
      # ãªãœsynthï¼Ÿâ†’ å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã›ãšã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼šãƒ€ãƒŸãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ä½¿ç”¨ã—ã¦å®Ÿéš›ã®æƒ…å ±ã‚’éš è”½
      - name: CDK Synth (Dev) - Security Safe
        run: npm run synth:dev --workspace=packages/infra
        env:
          # ãƒ€ãƒŸãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®šï¼ˆå®Ÿéš›ã®æƒ…å ±ã®æµå‡ºã‚’é˜²ãï¼‰
          # ãªãœãƒ€ãƒŸãƒ¼ï¼Ÿâ†’ ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã§å®Ÿéš›ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’éš ã™ãŸã‚
          CDK_DEFAULT_ACCOUNT: "123456789012"
          CDK_DEFAULT_REGION: "us-east-1"

      # ç”Ÿæˆã•ã‚ŒãŸCDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜
      # ãªãœä¿å­˜ï¼Ÿâ†’ å•é¡ŒãŒã‚ã£ãŸæ™‚ã®èª¿æŸ»ã€ãƒ‡ãƒ—ãƒ­ã‚¤å†…å®¹ã®ç¢ºèªã®ãŸã‚
      - name: Upload CDK outputs
        uses: actions/upload-artifact@v4
        with:
          name: cdk-outputs
          path: packages/infra/cdk.out/
          retention-days: 7

  # å…¨ã‚¸ãƒ§ãƒ–å®Œäº†ã®ç¢ºèª
  # ãªãœå¿…è¦ï¼Ÿâ†’ ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸã“ã¨ã‚’æ˜ç¢ºã«ç¤ºã™
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    # ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    needs: [lint-and-format, type-check, test, build, cdk-synth]
    # å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ãŒã‚ã£ã¦ã‚‚å®Ÿè¡Œ
    # ãªãœalwaysï¼Ÿâ†’ å¤±æ•—ã®è¦ç´„ã‚’æä¾›ã™ã‚‹ãŸã‚
    if: always()

    steps:
      # å…¨ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
      - name: Check all jobs
        run: |
          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ç¢ºèª
          if [[ "${{ needs.lint-and-format.result }}" != "success" || \
                "${{ needs.type-check.result }}" != "success" || \
                "${{ needs.test.result }}" != "success" || \
                "${{ needs.build.result }}" != "success" || \
                "${{ needs.cdk-synth.result }}" != "success" ]]; then
            echo "âŒ One or more CI jobs failed"
            # ãªãœexit 1ï¼Ÿâ†’ CIã‚’å¤±æ•—çŠ¶æ…‹ã«ã—ã¦ã€PRã®ãƒãƒ¼ã‚¸ã‚’é˜²ã
            exit 1
          else
            echo "âœ… All CI jobs passed successfully"
          fi
